<!DOCTYPE HTML>
<html lang="ja-JP">
<head>
	<meta charset="UTF-8">
	<title>PPD</title>
</head>
<body  onload="init()" oncontextmenu="return false;">
	右クリックで×（赤くなる）
	<canvas id="main" width="550" height="550"></canvas>
<script type="text/javascript">
const canvas = document.getElementById('main');
const ctx    = canvas.getContext('2d');
var baseWidth = 48;
var mode = -1;
var arr = [
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0], 
  [0, 0, 0, 0, 0, 0, 0]
];

var q = [0,0,0,0,0,0,0];
var yoko = ["", "", "", "", "", "", ""];
var tate = ["", "", "", "", "", "", ""];

const n0 = new Image(); n0.src = "./0.png";
const n1 = new Image(); n1.src = "./1.png";
const n2 = new Image(); n2.src = "./2.png";
const n3 = new Image(); n3.src = "./3.png";
const n4 = new Image(); n4.src = "./4.png";
const n5 = new Image(); n5.src = "./5.png";
const n6 = new Image(); n6.src = "./6.png";
const n7 = new Image(); n7.src = "./7.png";
const nImgs = [n0, n1, n2, n3, n4, n5, n6, n7];
const spNum = [127, 125, 123, 119, 111, 95, 85];

class Random {
	constructor(seed = 88675123) {
		this.x = 123456789;
		this.y = 362436069;
		this.z = 521288629;
		this.w = seed;
	}

	next() {
		let t;

		t = this.x ^ (this.x << 11);
		this.x = this.y; this.y = this.z; this.z = this.w;
		return this.w = (this.w ^ (this.w >>> 19)) ^ (t ^ (t >>> 8)); 
	}

	nextInt(max) {
		return Math.abs(this.next()) % max;
	}
}

function init(){
	for (i=0; i <= 7; i++) {
		h = baseWidth * 4 + baseWidth * i;
		if (i == 5) ctx.strokeStyle = '#000';
		else 	ctx.strokeStyle = '#bbb';
		ctx.beginPath();
		ctx.moveTo(0, h);
		ctx.lineTo(baseWidth * 11, h);
		ctx.moveTo(h, 0);
		ctx.lineTo(h, baseWidth * 11);
		ctx.stroke();
	}

	canvas.addEventListener('mousedown', function(e){
		let {x, y} = getCell(e);
		if(0 <= x && x <= 6){
			if(0 <= y && y <= 6){
				var now = arr[x][y];
				if (e.which == 3) mode = 2;
				else if (now == 0) mode = 1;
				else mode = 0;
				fill(x, y);
			}
		}
	}, false);
	canvas.addEventListener('mousemove', function(e){
		if (mode == -1) return;
		let {x, y} = getCell(e);
		if(0 <= x && x <= 6){
			if(0 <= y && y <= 6){
				fill(x, y);
			}
		}
	}, false);
	canvas.addEventListener('mouseup', function(e){
		mode = -1;
		check();
	}, false);
	ask((new Date()).getTime(), 0);
}

function getCell(e) {
	var x = Math.floor((e.offsetX - baseWidth * 4)/(baseWidth));
	var y = Math.floor((e.offsetY - baseWidth * 4)/(baseWidth));
	return {x: x, y: y}
}

function ask(seed, diff) {
	var random = new Random(seed);
	
	var sp = 3 - diff;
	for(i = 0; i < 7; i++) {
		var d = random.nextInt(128);
		q[i] = d;
	}
	for (i = 0; i < sp; i++) {
		q[random.nextInt(7)] = spNum[random.nextInt(spNum.length)];
	}
	for(i = 0; i < 7; i++) {
		var d = q[i];
		var yokoKey = "    ";
		if (d == 0) {
			yokoKey = "   0";
			yoko[i] = "   0";
		}else {
			var b = ("0000000" + d.toString(2)).slice(-7);
			var ren = 0;
			yokoKey = "    ";
			for (j = 0; j < 7; j++) {
				if (b.charAt(j) == '1') ren++;
				else if (ren > 0) {
					yokoKey = yokoKey + "" + ren;
					ren = 0;
				}
			}
			if (ren > 0) yokoKey = yokoKey + "" + ren;
			yokoKey = yokoKey.slice(-4);
			yoko[i] = yokoKey;
		}
		posY = baseWidth * 4 + baseWidth * i + 1;
		for (j = 0; j < 4; j++) {
			posX = baseWidth * j + 1;
			if (yokoKey.charAt(j) != ' ') {
				ctx.drawImage(nImgs[yokoKey.charAt(j)*1], posY, posX, baseWidth-2, baseWidth-2);
			} else {
				ctx.fillStyle = '#fff'
				ctx.fillRect(posY, posX, baseWidth-2, baseWidth-2);
			}
		}
	}

	for (j = 0; j < 7; j++) {
		var ren = 0;
		var tateKey = "    ";
		for(i = 0; i < 7; i++) {
			var b = ("0000000" + q[i].toString(2)).slice(-7);
			if (b.charAt(j) == '1') ren++;
			else if (ren > 0) {
				tateKey = tateKey + "" + ren;
				ren = 0;
			}
		}
		if (ren > 0) tateKey = tateKey + "" + ren;
		if (tateKey.length == 4) tate[j] = "   0";
		else tate[j] = tateKey.slice(-4);
		tateKey = tateKey.slice(-4);
		posX = baseWidth * 4 + baseWidth * j + 1;
		for (i = 0; i < 4; i++) {
			posY = baseWidth * i + 1;
			if (tateKey.charAt(i) != ' ') {
				ctx.drawImage(nImgs[tateKey.charAt(i)*1], posY, posX, baseWidth-2, baseWidth-2);
			} else {
				ctx.fillStyle = '#fff'
				ctx.fillRect(posY, posX, baseWidth-2, baseWidth-2);
			}
		}
	}
	
}

function fill(x,y) {
	if (mode == -1) return;
	posX = baseWidth * 4 + baseWidth * x + 1;
	posY = baseWidth * 4 + baseWidth * y + 1;
	if (mode == 1) ctx.fillStyle = '#000';
	else if (mode == 0) ctx.fillStyle = '#fff';
	else if (mode == 2) ctx.fillStyle = '#f00';
	arr[x][y] = mode;
	ctx.fillRect(posX, posY, baseWidth-2, baseWidth-2);
}

function check() {
	var ok = true;
	for(i = 0; i < 7; i++) {
		if (q[i] != arr2dec(i)) ok = false;
	}
	if (ok) alert("ok");
}
function arr2dec(i) {
	var str = "";
	for(j = 0; j < 7; j++) {
		if (arr[i][j] == 1) {
			str = str + "1";
		} else {
			str = str + "0";
		}
	}
	return parseInt(str,2);
}
</script>
</body>
</html>
